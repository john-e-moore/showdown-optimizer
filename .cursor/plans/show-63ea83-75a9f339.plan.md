<!-- 75a9f339-f5bb-4c3a-9837-ad556e26c6ea 4acaf781-f79e-4908-974a-90046449b827 -->
# Add diversification step to showdown pipeline

## Goals

- **Filter out weak lineups** by dropping any with `top1_pct_finish_rate < 1.0`.
- **Select exactly X lineups** from the remaining set that are as diversified as possible while still **preferring higher top1% finish rates**.
- **Integrate diversification into the existing pipeline** so `run_full.sh` runs this as an explicit final step.

## Step 1: Implement diversification module

- **Create new module** [`src/diversify_lineups.py`](src/diversify_lineups.py).
- Reuse utilities from [`src/top1pct_finish_rate.py`](src/top1pct_finish_rate.py):
- Import `_resolve_latest_excel` to locate the latest workbook in `outputs/top1pct/`.
- Import `_parse_player_name` to strip ownership annotations from `cpt` / `flex1`–`flex5` columns.
- Implement loader:
- Resolve the top1pct Excel path (either explicit CLI arg or latest in `outputs/top1pct/`).
- Read the `Lineups_Top1Pct` sheet into a DataFrame.
- Implement diversification helpers:
- Build a **player set** for each lineup (e.g., `frozenset({"Player A", ...})` from `cpt`, `flex1`–`flex5`).
- Greedy selection algorithm:
- Filter to `top1_pct_finish_rate >= min_top1_pct` (default `1.0`).
- Sort candidates by `top1_pct_finish_rate` (desc), then by `lineup_projection` (desc) as a tiebreaker.
- Iterate in that order, accepting a lineup if its **overlap with every already-selected lineup** is `<= max_overlap` (e.g., at most 4 shared players in Showdown) and stop when we’ve selected `X` lineups.
- Return selected rows as a new DataFrame.
- Implement `run(...)` function:
- Parameters: `num_lineups` (X), `min_top1_pct` (default `1.0`), `max_overlap` (default `4`), `top1pct_excel` (optional path override).
- Call the helpers above and write the result to a new Excel file under `outputs/top1pct/`, e.g. `top1pct_diversified_{num_lineups}.xlsx` with sheet `Lineups_Diversified`.

## Step 2: Add CLI for diversification module

- **Add argument parser** in `diversify_lineups.py`:
- `--num-lineups` (required): X lineups to select.
- `--min-top1-pct` (optional, default `1.0`): minimum `top1_pct_finish_rate` in percent.
- `--max-overlap` (optional, default `4`): maximum shared players allowed between any pair of selected lineups.
- `--top1pct-excel` (optional): explicit path to a top1pct workbook; if omitted, use latest.
- **Wire `main()`** to parse args and call `run(...)`, ensuring it’s invokable via `python -m src.diversify_lineups ...`.

## Step 3: Integrate diversification into `run_full.sh`

- **Extend script arguments** in [`run_full.sh`](run_full.sh):
- Keep existing arguments 1–6 intact.
- Add a 7th optional positional argument for diversified lineup count, e.g. `DIVERSIFIED_NUM` (default something sensible like `150` or `NUM_LINEUPS`).
- **Add Step 4 logging** after the current "Step 3/3" top1pct call:
- Echo a new section header `"Step 4/4: Selecting diversified lineups"`.
- Show the chosen `DIVERSIFIED_NUM` and fixed parameters (e.g., `min_top1_pct=1.0`, `max_overlap=4`) or wire them to configurable env vars if desired.
- **Invoke the new module**:
- Add a call such as:
- `python -m src.diversify_lineups --num-lineups "${DIVERSIFIED_NUM}" --min-top1-pct 1.0 --max-overlap 4`
- Rely on `diversify_lineups` to automatically use the latest `outputs/top1pct/top1pct_lineups_*.xlsx`.

## Step 4: Update documentation

- **README update** in [`README.md`](README.md):
- Document the diversification step conceptually: filtering by `top1_pct_finish_rate >= 1%` and enforcing a max player-overlap constraint.
- Add usage examples for `diversify_lineups` as a standalone CLI and illustrate the extended `run_full.sh` signature, including the new `DIVERSIFIED_NUM` parameter.

## Step 5: Sanity checks

- **Local test run**:
- Run `run_full.sh` with a small slate and confirm that:
- Correlation file is created.
- Initial lineups workbook is written.
- Top1pct workbook is written.
- Diversified workbook is produced with at most X lineups and all have `top1_pct_finish_rate >= 1.0`.
- Spot-check a few selected lineups to confirm that player overlap respects the `max_overlap` constraint and that higher `top1_pct_finish_rate` lineups are generally preferred.

### To-dos

- [ ] Implement src/diversify_lineups.py to load top1pct lineups, filter by min top1% rate, and greedily select X diversified lineups based on a max-overlap constraint.
- [ ] Add CLI argument parsing and main() in diversify_lineups.py to support Python -m execution.
- [ ] Extend run_full.sh with a new optional diversified lineup count argument and add a Step 4/4 that calls the diversify_lineups module.
- [ ] Update README.md to document the diversification step, new CLI, and the extended run_full.sh usage.
- [ ] Run the full pipeline end-to-end on a sample slate to validate that diversified outputs are created and obey the filtering and overlap constraints.