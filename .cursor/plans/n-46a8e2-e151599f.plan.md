<!-- e151599f-9980-4849-b58e-a3d4f6be5bb3 336c53c6-3e5b-4ade-85a0-619f8bce2712 -->
# Refactor NFL modules into src/nfl/

## Goal

Move NFL-specific modules out of the `src/` root into `src/nfl/`, keep shared logic in `src/shared/`, and adjust imports/CLIs so both NFL and NBA flows run cleanly under the new structure (no backward-compat shims needed).

## Step 1: Inventory and classify current modules

- **Catalog NFL entrypoints**: Confirm which top-level scripts are NFL-focused: [`src/main.py`](src/main.py), [`src/showdown_optimizer_main.py`](src/showdown_optimizer_main.py), [`src/top1pct_finish_rate.py`](src/top1pct_finish_rate.py), [`src/diversify_lineups.py`](src/diversify_lineups.py), [`src/flashback_sim.py`](src/flashback_sim.py), [`src/fill_dkentries.py`](src/fill_dkentries.py), [`src/download_nfl_data.py`](src/download_nfl_data.py).
- **Catalog NFL support modules**: Confirm NFL-only core pieces such as [`src/config.py`](src/config.py) (NFL config), [`src/build_corr_matrix_from_projections.py`](src/build_corr_matrix_from_projections.py), [`src/simulation_corr.py`](src/simulation_corr.py), and any NFL-specific data loading helpers (e.g. [`src/data_loading.py`](src/data_loading.py)).
- **Confirm truly shared utilities**: Verify which modules under `src/` are already used by NBA or clearly generic (e.g. [`src/shared/*`](src/shared), diagnostics/utils) so they stay where they are or get moved into `shared/` rather than `nfl/`.

## Step 2: Create `src/nfl/` package layout and move NFL modules

- **Ensure package skeleton**: Keep [`src/nfl/__init__.py`](src/nfl/__init__.py) as the NFL package root (adding minimal exports or docstring as desired).
- **Move NFL config and correlation pipeline**:
- Move [`src/config.py`](src/config.py) to [`src/nfl/config.py`](src/nfl/config.py) and adjust its internal imports to use `.shared.config_base` or absolute `src.shared` as appropriate.
- Move [`src/build_corr_matrix_from_projections.py`](src/build_corr_matrix_from_projections.py) to [`src/nfl/build_corr_matrix_from_projections.py`](src/nfl/build_corr_matrix_from_projections.py) and [`src/simulation_corr.py`](src/simulation_corr.py) to [`src/nfl/simulation_corr.py`](src/nfl/simulation_corr.py), updating imports in these files and in the NFL main/flashback modules to use `from . import config, simulation_corr, build_corr_matrix_from_projections`.
- Move the NFL correlation CLI [`src/main.py`](src/main.py) to [`src/nfl/main.py`](src/nfl/main.py) and update its imports to the new local NFL modules.
- **Move NFL top1pct/diversify/flashback/fill-dkentries CLIs**:
- Move [`src/top1pct_finish_rate.py`](src/top1pct_finish_rate.py) to [`src/nfl/top1pct_finish_rate.py`](src/nfl/top1pct_finish_rate.py) keeping its wrapper role over `src.shared.top1pct_core` but pointing to `.config` for paths.
- Move [`src/diversify_lineups.py`](src/diversify_lineups.py) to [`src/nfl/diversify_lineups.py`](src/nfl/diversify_lineups.py) and ensure it wraps `src.shared.diversify_core` with NFL `OUTPUTS_DIR`.
- Move [`src/flashback_sim.py`](src/flashback_sim.py) to [`src/nfl/flashback_sim.py`](src/nfl/flashback_sim.py) and wire it to `.config`, `.build_corr_matrix_from_projections`, and `.simulation_corr`.
- Move [`src/fill_dkentries.py`](src/fill_dkentries.py) to [`src/nfl/fill_dkentries.py`](src/nfl/fill_dkentries.py) and keep it as the NFL DKEntries wrapper.
- Move any clearly NFL-only helper like [`src/download_nfl_data.py`](src/download_nfl_data.py) (and, if applicable, [`src/data_loading.py`](src/data_loading.py)) under `src/nfl/`.

## Step 3: Tighten shared vs NFL boundaries for optimizer and DKEntries

- **Lineup optimizer adapter**:
- Decide on the home for [`src/lineup_optimizer.py`](src/lineup_optimizer.py), which is a thin adapter around `src.shared.optimizer_core` but currently lives at the root and is used by both NFL and NBA.
- Prefer moving it to [`src/shared/lineup_optimizer.py`](src/shared/lineup_optimizer.py) (or similar) and updating imports in [`src/nfl/showdown_optimizer_main.py`](src/nfl/showdown_optimizer_main.py) and [`src/nba/showdown_optimizer_main.py`](src/nba/showdown_optimizer_main.py) to reference the shared adapter.
- While moving, update module/docstrings to describe it as sport-agnostic and ensure any NFL-specific assumptions (e.g., position names) are either generalized or documented.
- **Showdown constraints**:
- Review [`src/showdown_constraints.py`](src/showdown_constraints.py) to separate generic team-stack helpers (used by NBA) from NFL-specific positional constraints.
- Either keep the whole module as shared but clarify docstrings, or split into [`src/shared/showdown_constraints.py`](src/shared/showdown_constraints.py) (generic pieces) plus optional NFL-only constraint config under `src/nfl/` if needed.
- **DKEntries/ownership helpers**:
- Factor shared logic currently embedded in [`src/fill_dkentries.py`](src/fill_dkentries.py) (e.g. ownership/exposure computation) into [`src/shared/dkentries_core.py`](src/shared/dkentries_core.py) if not already present, parameterized by `outputs_dir` and `flex_role_label`.
- Update [`src/nfl/fill_dkentries.py`](src/nfl/fill_dkentries.py) and [`src/nba/fill_dkentries_nba.py`](src/nba/fill_dkentries_nba.py) to call this shared core instead of importing helpers from the NFL module, so both sports use their own `config.OUTPUTS_DIR` and DKEntries role labels (FLEX vs UTIL) correctly.

## Step 4: Update imports, CLIs, and documentation

- **Adjust internal imports**:
- Sweep the codebase for imports of the moved NFL modules (e.g. `from src import config`, `from . import config, simulation_corr`, direct references to `build_corr_matrix_from_projections`, `flashback_sim`, `top1pct_finish_rate`, `diversify_lineups`, `fill_dkentries`) and update them to `src.nfl.*` or relative `from .`/`from ..nfl` as appropriate.
- Ensure NBA modules (e.g. [`src/nba/flashback_sim_nba.py`](src/nba/flashback_sim_nba.py), [`src/nba/top1pct_finish_rate_nba.py`](src/nba/top1pct_finish_rate_nba.py), [`src/nba/fill_dkentries_nba.py`](src/nba/fill_dkentries_nba.py)) no longer depend on root-level NFL modules after the move.
- **Standardize CLI invocations**:
- Update docstrings and any README or usage comments so NFL commands use `python -m src.nfl.<module>` and NBA commands use `python -m src.nba.<module>`.
- Optionally add brief comments in [`src/__init__.py`](src/__init__.py) and [`src/nfl/__init__.py`](src/nfl/__init__.py) describing the new package layout (shared vs sport-specific) for future maintainers.

## Step 5: Add and run smoke tests for NFL and NBA flows

- **NFL smoke tests**:
- For each NFL entrypoint, run with `--help` (or minimal safe args) to ensure imports and argument parsing work under the new package paths: `python -m src.nfl.main --help`, `python -m src.nfl.showdown_optimizer_main --help`, `python -m src.nfl.top1pct_finish_rate --help`, `python -m src.nfl.diversify_lineups --help`, `python -m src.nfl.flashback_sim --help`, `python -m src.nfl.fill_dkentries --help`.
- Optionally, if you have small sample data checked in, run a single short end-to-end pipeline (e.g. with `--num-lineups 1` or reduced `--num-sims`) to validate that file paths and outputs directories resolve correctly under `config.OUTPUTS_DIR`.
- **NBA smoke tests**:
- Re-run the analogous NBA CLIs with `--help` to ensure they still import correctly after refactoring shared adapters: `python -m src.nba.main --help`, `python -m src.nba.showdown_optimizer_main --help`, `python -m src.nba.top1pct_finish_rate_nba --help`, `python -m src.nba.diversify_lineups_nba --help`, `python -m src.nba.flashback_sim_nba --help`, `python -m src.nba.fill_dkentries_nba --help`.
- Confirm that NBA paths (e.g., `outputs/nba/*`, `data/nba/*`) are unaffected and that any shared utilities now use NBA config instead of NFL defaults.
- **Optional automated check**:
- If you have or want tests, add a small test module (e.g., under `tests/`) that imports all key entrypoints from `src.nfl.*` and `src.nba.*` to catch regressions in import paths going forward.

### To-dos

- [ ] Inventory and classify all NFL-specific vs shared modules under `src/` (entrypoints, config, correlation, DKEntries, optimizer, constraints).
- [ ] Physically move NFL-specific modules into `src/nfl/` and fix their internal relative imports (config, correlation, wrappers).
- [ ] Refactor shared optimizer and DKEntries helpers into `src/shared/` where appropriate and update NFL and NBA modules to use them instead of cross-sport imports.
- [ ] Update all imports and CLI usage strings/docs to the new `src.nfl.*` and `src.nba.*` paths without backward-compat shims.
- [ ] Add and run simple smoke tests (CLI `--help`/minimal runs) for both NFL and NBA entrypoints to confirm the new layout works end to end.