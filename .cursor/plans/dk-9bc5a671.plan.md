<!-- 9bc5a671-b9b8-40fb-9cce-15fe91e7ef90 400402ed-3ac4-468b-8292-b25935e6cba6 -->
# DKEntries-aware run_full integration

### Goal

Wire the existing Showdown pipeline into DraftKings Entries so that:

- **Diversified lineup count** defaults to the number of actual entries in the latest `DKEntries*.csv` under `data/dkentries/` (while still allowing a manual override).
- **Filled DKEntries CSVs** are written under `outputs/dkentries/` with lineup slots formatted as `{player_name} ({player_id})`.
- **Player exposure across entry fees** is diversified so that the same players are not overly concentrated in one dollar tier.

### 1. Infer diversified lineup count from latest DKEntries

- **Add a small helper module** (e.g., [`src/dkentries_utils.py`](src/dkentries_utils.py)) that:
- Locates the most recent `DKEntries*.csv` in [`data/dkentries/`](data/dkentries/) using file modification time.
- Loads it with pandas and counts the number of "real" entries as rows with a non-empty `Entry ID`.
- Exposes a tiny CLI (e.g., `python -m src.dkentries_utils --count-entries`) that prints this count to stdout.
- **Update `run_full.sh`** so that `DIVERSIFIED_NUM` is set as:
- If a 7th argument is provided, use that value (explicit override).
- Otherwise, shell-substitute the helper output, e.g. calling `python -m src.dkentries_utils --count-entries`.

### 2. Produce a filled DKEntries CSV under outputs/dkentries

- **Create a new script** (e.g., [`src/fill_dkentries.py`](src/fill_dkentries.py)) that:
- Resolves the latest `DKEntries*.csv` under [`data/dkentries/`](data/dkentries/) (reusing the helper from step 1).
- Resolves the latest diversified lineups workbook under `outputs/top1pct/` (e.g., `top1pct_diversified_{num}.xlsx`) using logic similar to `_resolve_latest_excel` in [`src/top1pct_finish_rate.py`](src/top1pct_finish_rate.py).
- Optionally accepts explicit `--dkentries-csv`, `--diversified-excel`, and `--sabersim-csv` overrides for flexibility.
- **Map diversified lineups to DraftKings players**:
- Load the diversified lineups sheet (`Lineups_Diversified`) from the Excel file and read lineup columns (`cpt`, `flex1`–`flex5`).
- Use the existing `_parse_player_name` helper from [`src/top1pct_finish_rate.py`](src/top1pct_finish_rate.py) to strip any extra decorations from lineup cells down to raw player names.
- Load the Sabersim projections CSV used by the run (passed from `run_full.sh` to `fill_dkentries.py`) and build a mapping from `Name` → `DFS ID`.
- For each lineup slot, look up the player ID via this mapping and format the DK string as `{Name} ({DFS ID})`.
- **Write the filled DKEntries CSV**:
- Load the latest DKEntries CSV as a template; identify entry rows via non-empty `Entry ID`.
- Check that the diversified lineup set has at least as many rows as DK entries; if not, raise a clear error.
- Assign one lineup to each entry row and overwrite the `CPT`/`FLEX` columns with the `{player_name} ({player_id})` strings while preserving all other DK columns and headers.
- Write the result to `outputs/dkentries/DKEntries_{timestamp}.csv`, where `timestamp` is passed in from `run_full.sh` so outputs from one pipeline run share the same timestamp.

### 3. Diversify player exposure across entry fee tiers

- **Model exposure by fee tier**:
- When assigning diversified lineups to DK entries, treat each distinct `Entry Fee` value in the DKEntries template as a fee tier.
- Precompute global lineup-level exposure counts per player across all diversified lineups.
- Maintain per-tier exposure counts (player → # of assigned lineups at that fee).
- **Greedy fee-aware assignment algorithm**:
- Iterate over DK entries in a sensible order (e.g., descending `Entry Fee`, breaking ties by original row order).
- For each entry, choose among the remaining unassigned lineups the one that:
- Keeps per-tier player exposure as close as possible to a balanced target (e.g., each player’s appearances spread across fee tiers rather than concentrated in a single one), using a simple imbalance score on the per-tier counts.
- Uses top1%/projection as a secondary tie-breaker so higher-fee entries preferentially get stronger lineups.
- After all entries are assigned, compute and (optionally) log a small exposure summary per fee tier for sanity checking.

### 4. Integrate the new step into run_full.sh

- **Extend `run_full.sh`** with a new step after diversification:
- Reuse the existing `timestamp` variable and the resolved `SABERSIM_CSV`.
- Call `python -m src.fill_dkentries` with arguments that:
- Point it at the same Sabersim CSV and the latest DKEntries file, or let it auto-resolve based on the project root.
- Set `--output-csv` to `outputs/dkentries/DKEntries_${timestamp}.csv`.
- **Document usage** in `README.md` under the `run_full.sh` section so it’s clear that:
- If `DIVERSIFIED_NUM` is omitted, it defaults to the number of entries in the latest DKEntries file.
- A DK-upload-ready CSV is now produced automatically in `outputs/dkentries/` with `{player_name} ({player_id})` lineup slots and fee-aware exposure diversification.

### To-dos

- [ ] Add dkentries helper module to resolve latest DKEntries*.csv, count real entries, and expose a small CLI used by run_full.sh.
- [ ] Update run_full.sh to derive DIVERSIFIED_NUM from the DKEntries entry count when the 7th argument is omitted, keeping the explicit override behavior when it is provided.
- [ ] Implement fill_dkentries.py to map diversified lineups to player IDs via the Sabersim CSV and write a filled DKEntries CSV under outputs/dkentries/ with lineup cells formatted as '{player_name} ({player_id})'.
- [ ] Inside fill_dkentries.py, implement a greedy fee-aware lineup-to-entry assignment that spreads each player’s exposure across distinct Entry Fee tiers while favoring stronger lineups in higher-fee contests.
- [ ] Wire the new fill_dkentries step into run_full.sh after diversification, passing the timestamp and Sabersim CSV, and update README.md to describe the new behavior and outputs.