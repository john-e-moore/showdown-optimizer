<!-- 326181c3-5541-41a2-8dff-1bfcf19388ed d298780e-51f9-46af-8806-3ef20b42d9b2 -->
# NBA Showdown Parity and Two-Sport Refactor

## Objective

Bring the NBA side up to parity with NFL for the full DraftKings Showdown pipeline (correlations → optimizer → top 1% → diversification → DKEntries → flashback) while refactoring the codebase into **shared**, **NFL**, and **NBA** layers with sport-aware CLIs and clear directory conventions.

## Phase 1: Directory and config alignment

- **Sport-aware data/outputs layout**
- Standardize on `data/nfl/...` and `data/nba/...` (with `sabersim/`, `contests/`, `dkentries/`, `payouts/`, etc.).
- Standardize on `outputs/nfl/...` and `outputs/nba/...` (with `correlations/`, `lineups/`, `top1pct/`, `flashback/`, `dkentries/`).
- **Shared config base**
- Ensure `src/shared/config_base.py` exposes `PROJECT_ROOT`, `DATA_DIR`, `OUTPUTS_DIR`, and any other common paths.
- Adapt `src/config.py` (NFL) and `src/nba/config.py` (NBA) to import from `shared.config_base` and set sport-specific `DATA_DIR` / `OUTPUTS_DIR` roots.
- **Eliminate hard-coded paths**
- Sweep the codebase for bare `data/` and `outputs/` usages.
- Replace with `config.DATA_DIR`, `config.OUTPUTS_DIR` (NFL) or `nba.config.DATA_DIR`, `nba.config.OUTPUTS_DIR` (NBA), except in top-level docs/examples.

## Phase 2: Shared optimizer core and sport-specific CLIs

- **Extract shared optimizer core** (`src/shared/optimizer_core.py`)
- Move generic MILP structures and logic from `src/lineup_optimizer.py` and `src/showdown_constraints.py`:
- Types and containers: `Player`, `PlayerPool`, `Lineup`, `SLOTS`, `CPT_SLOT`, `FLEX_SLOTS`, `VarKey`, `VarDict`.
- Model-building functions: `build_showdown_model`, constraint helpers (single CPT, flex counts, uniqueness, salary cap, eligibility, team min/max, etc.), and objective setup.
- Wrapper functions for projection caps, no-duplicate logic, and solution extraction: `_build_showdown_model_with_constraints`, `_add_projection_cap_constraint`, `_extract_lineup_from_solution`, `solve_single_lineup`, `optimize_showdown_lineups`.
- **Refactor NFL optimizer to use the core**
- Update `src/showdown_constraints.py` to import shared `Player`, `PlayerPool`, `CPT_SLOT`, `SLOTS`, and generic constraint helpers from `shared.optimizer_core`, keeping NFL-only logic (e.g., QB/pass-catcher stacks, RB CPT vs opposing DST) local.
- Slim `src/lineup_optimizer.py` to an NFL adaptor: re-export shared core symbols and keep only NFL-specific CSV loading from Sabersim.
- Ensure NFL optimizer writes lineups to `config.OUTPUTS_DIR / "lineups"` (i.e. `outputs/nfl/lineups`).
- **Add NBA optimizer CLI** (`src/nba/showdown_optimizer_main.py`)
- Implement a new NBA entrypoint mirroring NFL CLI flags: `--sabersim-glob`, `--num-lineups`, `--salary-cap`, `--chunk-size`, and any stacking options that make sense for NBA.
- Implement an NBA Sabersim loader that builds `shared.optimizer_core.Player` objects from NBA Sabersim CSVs and returns a `PlayerPool`.
- Call `optimize_showdown_lineups` with NBA-specific (or empty) `ConstraintBuilder`s.
- Write NBA lineups to `nba.config.OUTPUTS_DIR / "lineups"`.

## Phase 3: Shared top 1% and diversification pipelines

- **Extract top 1% core** (`src/shared/top1pct_core.py`)
- Move sport-agnostic logic from `src/top1pct_finish_rate.py` into a shared module:
- Helpers to resolve latest lineups/correlations workbooks and load them.
- Player universe and correlation matrix construction.
- Simulation loop that samples outcomes, computes field thresholds, and builds lineup weights.
- Expose a public `run_top1pct(field_size, outputs_dir, ...)` that reads from `outputs_dir / "lineups"` and `outputs_dir / "correlations"` and writes to `outputs_dir / "top1pct"`.
- **NFL/NBA wrappers for top 1%**
- Keep `src/top1pct_finish_rate.py` as an NFL CLI wrapper that calls `run_top1pct(..., outputs_dir=config.OUTPUTS_DIR, ...)`.
- Add `src/nba/top1pct_finish_rate_nba.py` mirroring the NFL flags and calling the shared core with `outputs_dir=nba.config.OUTPUTS_DIR`.
- **Extract diversification core** (`src/shared/diversify_core.py`)
- Move generic diversification logic from `src/diversify_lineups.py` into a shared module:
- Loading top 1% lineups, building player sets, computing exposures.
- Greedy selection algorithm based on max overlap / min top-1% constraints.
- Expose `run_diversify(num_lineups, outputs_dir, ...)` that reads from `outputs_dir / "top1pct"` and writes diversified workbooks back to that directory.
- **NFL/NBA wrappers for diversification**
- Update `src/diversify_lineups.py` to delegate to `shared.diversify_core.run_diversify(..., outputs_dir=config.OUTPUTS_DIR, ...)`.
- Add `src/nba/diversify_lineups_nba.py` to call the same core with `outputs_dir=nba.config.OUTPUTS_DIR`.

## Phase 4: Shared DKEntries and flashback components

- **Shared DKEntries core** (`src/shared/dkentries_core.py`)
- Extract from `src/dkentries_utils.py` and `src/fill_dkentries.py` the sport-agnostic pieces:
- Resolving the latest DKEntries template under `data/{sport}/dkentries`.
- Counting real entries and building mapping dictionaries from players/roles to IDs.
- Determining lineup slot columns and assigning optimized lineups to entries (fee-aware).
- Provide functions like `resolve_latest_dkentries_csv(data_dir, explicit=None)`, `_assign_lineups_fee_aware(...)`, and `_apply_assignments_to_dkentries(...)`.
- **NFL/NBA DKEntries wrappers**
- Keep `src/dkentries_utils.py` and `src/fill_dkentries.py` as NFL wrappers around the shared core using `config.DATA_DIR` and `config.OUTPUTS_DIR` for templates and outputs.
- Add `src/nba/fill_dkentries_nba.py` that mirrors the NFL CLI and uses `nba.config.DATA_DIR` / `nba.config.OUTPUTS_DIR`.
- **Shared flashback core** (`src/shared/flashback_core.py`)
- Extract from `src/flashback_sim.py` the sport-agnostic parts:
- Contest CSV parsing, lineup decoding, and player-universe construction.
- Correlation matrix handling, making matrices PSD, and simulating player scores.
- Computing finish rates, ROI, and summary tables for entrants and players.
- Implement `run_flashback(contest_csv, sabersim_csv, num_sims, random_seed, payouts_csv, config_module, dk_scoring_fn)` that uses `config_module.DATA_DIR` / `OUTPUTS_DIR` and a sport-specific DK scoring function.
- **NFL/NBA flashback wrappers**
- Simplify `src/flashback_sim.py` to a thin NFL CLI calling the shared core with NFL scoring.
- Add `src/nba/flashback_sim_nba.py` that parses analogous flags, uses `nba.config` paths, and passes an NBA DK scoring function (from the NBA stat sim module).

## Phase 5: NBA stat simulation and correlation

- **Define NBA stat schema and DK scoring**
- Decide on the set of simulated stats (e.g., PTS, REB, AST, STL, BLK, TOV, 3PM, bonuses) and how they map to DraftKings Showdown scoring.
- Implement a pure function `compute_dk_points_nba(stats_row)` encapsulating DK logic.
- **Implement NBA stat simulator** (`src/nba/stat_sim.py`)
- Build a simulator that samples per-player stat lines from Sabersim-like inputs, including game/team-level multipliers and overdispersion to match Sabersim means and standard deviations.
- Calibrate coupling and variance parameters so simulated DK distributions (means/stds/quantiles) roughly match provided Sabersim `dk_points` and `dk_std` where available.
- **NBA correlation builder**
- Implement an NBA correlation pipeline (`src/nba/simulation_corr.py` or similar) that:
- Uses the stat simulator to generate DK-point matrices.
- Computes correlation matrices across players.
- Writes correlation workbooks under `outputs/nba/correlations` with the same schema as NFL, so downstream tools can be shared.
- Run the full NBA correlation pipeline on at least one real slate (e.g., OKC–GSW) and manually inspect projections and correlations for sanity.

## Phase 6: End-to-end CLIs, shell scripts, and documentation

- **Shell entrypoints**
- Verify the NFL `run_full` script (e.g., `run_full.sh` or `run_full_nfl.sh`) runs the NFL pipeline end to end using the refactored modules.
- Add `run_full_nba.sh` that mirrors the NFL steps but calls the NBA modules:
- `src.nba.main` (correlations) → `outputs/nba/correlations`.
- `src.nba.showdown_optimizer_main` → `outputs/nba/lineups`.
- `src.nba.top1pct_finish_rate_nba` → `outputs/nba/top1pct`.
- `src.nba.diversify_lineups_nba` → diversified top-1% workbooks.
- `src.nba.fill_dkentries_nba` → filled DKEntries under `outputs/nba/dkentries`.
- **README and developer docs**
- Update `README.md` with a dedicated **NBA Showdown** section paralleling NFL:
- Data layout: where to put NBA Sabersim, contest, DKEntries, and payouts CSVs.
- Command examples for NBA correlations, optimizer, top 1%, diversification, DKEntries filling, and flashback.
- Add a brief module layout overview describing `src/shared`, NFL-specific modules under `src/`, and NBA-specific modules under `src/nba/`.
- **Validation and polishing**
- Run both NFL and NBA full pipelines on sample slates to confirm outputs land in the correct sport-specific folders and that downstream steps (top 1%, diversification, DKEntries, flashback) function without schema mismatches.
- Tweak logging, error messages, and CLI help text to clearly indicate sport and file locations.

### To-dos

- [ ] Audit and align `data/{sport}` and `outputs/{sport}` usage across configs and code, routing all paths through `shared.config_base` plus sport-specific config modules.
- [ ] Extract a sport-agnostic MILP optimizer core into `src/shared/optimizer_core.py` and refactor the NFL optimizer to depend on it.
- [ ] Implement and/or refactor NFL and NBA optimizer CLIs to use the shared optimizer core, with an NBA Sabersim loader and outputs under `outputs/nba/lineups`.
- [ ] Move generic top 1% and diversification logic into `src/shared/` and add NFL/NBA wrappers that point to sport-specific `outputs/{sport}` directories.
- [ ] Extract shared DKEntries and flashback logic into `src/shared/` and add NFL and NBA entrypoints with sport-specific paths and scoring functions.
- [ ] Define the NBA stat schema and DK scoring, implement `nba/stat_sim.py`, and build an NBA correlation pipeline that writes correlation workbooks under `outputs/nba/correlations`.
- [ ] Add or update sport-aware full-run shell scripts (NFL and NBA) and expand README with NFL vs NBA data layout, commands, and module overview.
- [ ] Run end-to-end NFL and NBA pipelines on real slates to validate outputs, schemas, and correlations, and make final parameter and documentation tweaks.