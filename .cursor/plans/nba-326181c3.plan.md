<!-- 326181c3-5541-41a2-8dff-1bfcf19388ed b4d661f5-8ef9-4f3a-9783-5ca8f09b8f10 -->
# NBA DKEntries UTIL Role Support

## Goal

Ensure the NBA DKEntries filling pipeline correctly understands DraftKings' `UTIL` roster role (rather than `FLEX`) so that diversified NBA lineups can be mapped into DKEntries CSVs without player-role lookup errors.

## Plan

- **Audit current DKEntries role handling**
- Review `shared/dkentries_core.py` for hard-coded assumptions about the FLEX role name (it currently uses `"CPT"` and `"FLEX"` when parsing the embedded player dictionary and when constructing `(player_name, role)` keys).
- Confirm the roster role values present in a real NBA DKEntries template (e.g., `Name`, `ID`, `Roster Position` with `CPT` and `UTIL`).
- Identify NBA entrypoints that depend on the shared core: `nba/fill_dkentries_nba.py` and any exposure/ownership helpers that assume the label `"FLEX"`.

- **Generalize the shared DKEntries core to support a configurable flex/UTIL label**
- In `shared/dkentries_core.py`, add a `flex_role_label` parameter (defaulting to `"FLEX"`) for functions that currently hard-code `"FLEX"`:
- `build_name_role_to_id_map(df, flex_role_label="FLEX")` should accept both `"CPT"` and `flex_role_label` when filtering the dictionary rows.
- `assign_lineups_fee_aware(...)` and `apply_assignments_to_dkentries(...)` should use `flex_role_label` instead of `"FLEX"` when constructing role keys for non-CPT slots.
- Keep the NFL behavior unchanged by continuing to call these functions with the default `flex_role_label="FLEX"` from `fill_dkentries.py`.

- **Update the NBA DKEntries wrapper to use UTIL**
- In `nba/fill_dkentries_nba.py`, update the calls into `dkentries_core` to pass `flex_role_label="UTIL"`:
- When building `name_role_to_id`, call `build_name_role_to_id_map(dk_df, flex_role_label="UTIL")` so that the mapping includes `(player_name, "UTIL")` keys.
- When applying assignments, call `apply_assignments_to_dkentries(..., flex_role_label="UTIL")` so that CPT stays `"CPT"` but all non-CPT slots use the `UTIL` role when looking up IDs.
- Ensure any logging, comments, or docstrings in the NBA filler reference `UTIL` instead of `FLEX` for clarity.

- **Verify end-to-end NBA DKEntries filling**
- With a real NBA DKEntries template (containing `CPT` and `UTIL` lineup slots and a `Roster Position` dictionary using `CPT`/`UTIL`):
- Run the NBA pipeline through diversification to produce `outputs/nba/top1pct/top1pct_diversified_*.xlsx`.
- Run `python -m src.nba.fill_dkentries_nba` and confirm:
- No `KeyError` is raised for players like `Chet Holmgren` in the UTIL role.
- The filled DKEntries CSV shows `CPT` and `UTIL` columns populated with `{player_name} ({player_id})` strings consistent with the DK template dictionary.
- Optionally, spot-check a few entries against the original DK template to ensure IDs and roles are correct.

- **Optional hardening and documentation**
- Add a small assertion or warning in the NBA filler that checks the roster-role values present in the DKEntries dictionary (`CPT` vs `UTIL`) and logs a clear message if unexpected roles are seen.
- Update the README NBA section (or a short DKEntries subsection) with a note that NFL uses `FLEX` while NBA uses `UTIL`, and that the tooling handles this automatically via the shared DKEntries core configuration.

### To-dos

- [ ] Audit `shared/dkentries_core.py` and NBA DKEntries templates to understand current assumptions about FLEX vs UTIL roster roles.
- [ ] Add a configurable `flex_role_label` parameter to key functions in `shared/dkentries_core.py` (mapping, assignment, application) and keep NFL behavior defaulted to `"FLEX"`.
- [ ] Update `nba/fill_dkentries_nba.py` to call the shared DKEntries core with `flex_role_label="UTIL"` so NBA uses CPT/UTIL consistently.
- [ ] Run the NBA pipeline through diversification and DKEntries filling with a real NBA DKEntries template to confirm UTIL-based mapping works and no KeyErrors occur.
- [ ] Optionally update README or inline docs to note that NFL uses FLEX while NBA uses UTIL, and that this is handled via the shared DKEntries core.