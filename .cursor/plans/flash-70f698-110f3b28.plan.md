<!-- 110f3b28-2d3d-4979-b964-af4b0a5683d7 15a3b8bb-30e7-4db4-97d8-cc289b915e8e -->
# Auto-fetch DraftKings payouts for flashback_sim

## Files to modify

- [`src/flashback_sim.py`](/home/john/showdown-optimizer/src/flashback_sim.py)
- [`README.md`](/home/john/showdown-optimizer/README.md)

## Step 1: Add DraftKings payouts download helper

- **HTTP imports and constants**: In `flashback_sim.py`, import `urllib.request` (and optionally `urllib.error`) and define a module-level URL template constant, e.g. `DK_PAYOUT_URL_TEMPLATE = "https://api.draftkings.com/contests/v1/contests/{contest_id}?format=json"`.
- **Helper function**: Add a small helper like `_download_payout_json(contest_id: str, dest_path: Path) -> bool` that:
- Builds the URL from `contest_id` using the template.
- Calls `urllib.request.urlopen(url, timeout=10)` and checks for a 200 response.
- Ensures the parent directory of `dest_path` exists (`mkdir(parents=True, exist_ok=True)`).
- Reads the body, parses it with `json.loads` to validate JSON, then writes it back to `dest_path` via `json.dump` (pretty-printing optional).
- Prints a short status message on success and returns `True`; on any network/parse error, prints a clear warning and returns `False` without raising.

## Step 2: Integrate download into _load_payout_structure

- **Current behavior**: `_load_payout_structure` currently infers `path = config.DATA_DIR / "payouts" / f"payouts-{contest_id}.json"` when `payouts_csv is None`, and if the file does not exist, it logs a warning and returns `None`, skipping ROI.
- **New behavior for missing default file**:
- In the `else` branch for `payouts_csv is None`, when the inferred `path` does not exist, call the new `_download_payout_json(contest_id, path)` instead of immediately returning `None`.
- If the helper returns `False`, keep the existing behavior: print a warning such as "Skipping ROI computation" and return `None` so the rest of the pipeline runs without ROI.
- If the helper returns `True`, proceed as if the file had been present from the start: fall through to the existing JSON loading and parsing logic that builds `payouts` and `entry_fee`.
- **Explicit payouts_csv unchanged**: If `--payouts-csv` is provided, keep the current behavior: require that file to exist and do not hit the DraftKings API.

## Step 3: Keep JSON parsing and ROI logic unchanged

- **Reuse existing structure**: Do not modify the downstream logic in `_load_payout_structure` that expects the DraftKings JSON shape (`raw["contestDetail"]["payoutSummary"]`, `entryFee`, etc.) or any of the ROI computation in `_compute_sim_roi` and `run`.
- **Logging**: Add minimal, clear print statements so that when the file is auto-downloaded, the CLI output shows which URL was used and where the JSON was written.

## Step 4: Update README documentation

- **Flashback section**: In the flashback section of `README.md`, update the description around `--payouts-csv` to note that:
- When `--payouts-csv` is omitted, the script first looks for `data/payouts/payouts-{contest_id}.json`.
- If that file is missing, it automatically calls the DraftKings endpoint `https://api.draftkings.com/contests/v1/contests/{contest_id}?format=json`, saves the response to `data/payouts/payouts-{contest_id}.json`, and then uses it for ROI computation.
- If the download fails (network error, non-200 response, or malformed JSON), the script falls back to skipping ROI as before.

## Step 5: Light manual test

- **Smoke test from CLI**:
- Remove or rename any existing `data/payouts/payouts-{contest_id}.json` for a known contest, then run `python -m src.flashback_sim` targeting that contest CSV without `--payouts-csv`.
- Confirm that the script logs the attempted download, writes a new JSON under `data/payouts/`, and that the resulting flashback Excel workbook includes `Sim ROI` / `Actual ROI` columns populated.
- Optionally test the explicit `--payouts-csv` path still works and does not trigger a download.

### To-dos

- [x] Add DraftKings payouts URL constant, urllib imports, and a `_download_payout_json` helper to flashback_sim.py.
- [x] Update `_load_payout_structure` to call the download helper when `payouts_csv` is None and the default payouts JSON is missing, keeping explicit `--payouts-csv` behavior unchanged.
- [x] Update README flashback section to document the new auto-download behavior for payouts when `--payouts-csv` is omitted and no local payouts JSON exists.
- [ ] Run flashback_sim against a real contest without a local payouts JSON to verify the API download, file creation, and ROI columns in the output workbook.