<!-- ae833f59-cfd7-4ab0-82ef-c7f0fbd76f90 bb4f39ef-79e8-401d-9849-96fa7f408a14 -->
# Implement chunked lineup optimization with --chunk-size

### 1. Extend the CLI to accept a --chunk-size flag

- **Locate entrypoint**: Use [`src/showdown_optimizer_main.py`](src/showdown_optimizer_main.py) as the main CLI for the lineup optimizer.
- **Add argparse option**: Add a `--chunk-size` integer argument (e.g., default `50`) with help text explaining that it controls how many lineups are solved per MILP chunk and that `0` or negative disables chunking.
- **Plumb argument through**: When calling `optimize_showdown_lineups(...)`, pass the new `chunk_size` value (or `None` if disabled) via a new parameter so the optimizer can choose between the existing and chunked algorithms.

### 2. Enhance the optimizer API to support chunking

- **Update function signature**: In [`src/lineup_optimizer.py`](src/lineup_optimizer.py), extend `optimize_showdown_lineups` to accept `chunk_size: int | None = None` (and optionally a small `projection_eps: float = 1e-4`), keeping existing parameters and return type unchanged.
- **Refactor model-building**: Extract a small helper like `build_showdown_model_with_constraints(player_pool, salary_cap, constraint_builders)` that wraps `build_showdown_model`, `add_base_constraints`, and applying `constraint_builders`, so it can be reused for each chunk.
- **Add projection cap helper**: Implement a helper `add_projection_cap_constraint(prob, x, player_pool, max_projection: float)` that builds the same weighted projection expression used in `set_mean_projection_objective` and adds a constraint `projection_sum <= max_projection`.

### 3. Implement the chunked solving loop

- **Branch on chunk_size**: Inside `optimize_showdown_lineups`, if `chunk_size` is `None` or `<= 0`, keep the current behavior (single model with growing no-duplicate constraints). If `chunk_size` is positive, run a new chunked loop.
- **Chunk loop structure**:
- Initialize `remaining = num_lineups`, `prev_min_proj: float | None = None`, and an empty `lineups` list.
- While `remaining > 0`:
- Compute `current_chunk_size = min(remaining, chunk_size)`.
- Build a fresh model via the new helper; if `prev_min_proj` is not `None`, call `add_projection_cap_constraint` with `max_projection = prev_min_proj - projection_eps`.
- Set the mean projection objective (`set_mean_projection_objective`).
- For `j` in `range(current_chunk_size)`: solve, break if status is not optimal; extract lineup, append to `lineups`, update `remaining`; track the minimum `lineup.projection()` seen in this chunk; add a per-chunk no-duplicate constraint (labelled with chunk and index) identical to the existing logic.
- After the inner loop, if at least one lineup was found, set `prev_min_proj` to the minimum projection from that chunk (minus `projection_eps` to strictly decrease the cap); if none were found, break the outer loop.
- Return the accumulated `lineups` (which will be ordered by decreasing projection across chunks).

### 4. Keep backward compatibility and edge-case handling

- **Small num_lineups / chunk_size**: Handle cases where `num_lineups < chunk_size` by naturally producing just one chunk with `current_chunk_size = min(num_lineups, chunk_size)`.
- **Infeasibility handling**: Reuse the existing status checks; if a chunk hits infeasibility immediately, break out and return what has been found so far.
- **Projection consistency**: Ensure the projection expression in `add_projection_cap_constraint` matches `Lineup.projection()` (1.5× CPT, 1× FLEX) so the cap is aligned with reported projections.

### 5. Update docs and help text

- **CLI help**: Expand the `--chunk-size` help string in [`src/showdown_optimizer_main.py`](src/showdown_optimizer_main.py) to mention the default (e.g., 50) and the special value (0) to disable chunking.
- **Developer docs**: Optionally add a short note to [`README.md`](README.md) describing the new flag, its purpose (improving performance for large `--num-lineups`), and how the chunked method preserves global ordering of lineups by projection.

### To-dos

- [ ] Add a --chunk-size flag to showdown_optimizer_main.py, wire it through argparse, and pass it when calling optimize_showdown_lineups.
- [ ] Extend optimize_showdown_lineups in lineup_optimizer.py to accept an optional chunk_size parameter and factor out shared model-building and projection-cap helpers.
- [ ] Implement the chunked solving loop that rebuilds the MILP per chunk, applies a projection cap based on the previous chunk’s minimum projection, and adds per-chunk no-duplicate constraints.
- [ ] Update CLI help and README to document the new --chunk-size behavior and recommended values for large num-lineups runs.