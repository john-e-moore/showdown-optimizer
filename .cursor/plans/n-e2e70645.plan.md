<!-- e2e70645-586d-4cd2-be3f-d2d0d91a5eff e9af0533-33b3-41a7-9cb1-be67d8381989 -->
# NFL Data Download Script Plan

## Goal

- **Objective**: Provide a Python script that uses `nfl_data_py` to download historical NFL player-game stats and games/schedule data for regular seasons (2005+) and save them as Parquet files at the paths expected by the existing correlation pipeline.
- **Key constraint**: The saved Parquet files must expose column names that align with the canonical schema already used by `src/config.py` and `src/data_loading.py`, so the rest of the pipeline works without changes (or with minimal, clearly-documented adjustments).

## 1. Dependency and configuration

- **Add dependency**: Include `nfl_data_py` in `requirements.txt` so the downloader can be installed with the rest of the project.
- **Confirm paths**: Reuse `config.NFL_PLAYER_GAMES_PARQUET` and `config.NFL_GAMES_PARQUET` as the output destinations for the downloaded Parquet files, respecting the existing directory structure `data/nfl_raw/`.
- **Season range**: Use the same season filtering as the pipeline (regular-season 2005+), with the upper bound defaulting to the latest season available from `nfl_data_py`.

## 2. Script design (`src/download_nfl_data.py`)

- **Module API**:
- Implement `download_player_game_stats(seasons: list[int]) -> pd.DataFrame `using `nfl_data_py` (e.g., weekly or play-by-play-based player stats) and return a dataframe containing one row per player-game.
- Implement `download_games(seasons: list[int]) -> pd.DataFrame `using `nfl_data_py` schedules/games API and return a dataframe with one row per game.
- Implement a `main()` function that:
  - Parses optional CLI arguments (`--start-season`, `--end-season`, `--overwrite`) with sensible defaults (e.g., 2005 to latest season from `nfl_data_py`).
  - Calls the two download functions, normalizes column names, filters to regular season only, and writes Parquet files to `config.NFL_PLAYER_GAMES_PARQUET` and `config.NFL_GAMES_PARQUET`.

## 3. Column schema alignment with existing pipeline

- **Understand canonical schema**:
- Player-game Parquet must contain: `game_id`, `player_id`, `season`, `week`, `team`, `opponent`, `position`, plus box-score stats using names already assumed in `config.RAW_TO_CANONICAL_STATS` (e.g., `passing_yards`, `passing_tds`, `interceptions`, `rushing_yards`, `rushing_tds`, `receiving_yards`, `receiving_tds`, `receptions`).
- Games Parquet must contain: `game_id`, `season`, `week`, `home_team`, `away_team`, `home_score`, `away_score`, `season_type`.
- **Map nfl_data_py columns to canonical names inside the downloader script**:
- For player stats, rename nfl_data_py columns (e.g., `recent_team` or `team`, `opponent_team`, `pass_yards`/`passing_yards`, etc.) to match the canonical names defined in `src/config.py`.
- For schedules/games, rename nfl_data_py columns (e.g., `home_team`, `away_team`, `home_score`, `away_score`, `season_type`, `game_id`, `season`, `week`) to exactly match the canonical names if they differ.
- After renaming, ensure that the resulting dataframes satisfy the minimum column requirements enforced by `src/data_loading.py` so it can simply `pd.read_parquet` and proceed.
- **Minimize changes to existing code**:
- Prefer doing all schema normalization in `download_nfl_data.py` so that `config.RAW_TO_CANONICAL_STATS` and `data_loading.load_*` remain valid for both nfl_data_py-generated Parquet and any external Parquet that already matches the canonical schema.
- Only extend `RAW_TO_CANONICAL_STATS` if necessary (e.g., if nfl_data_py uses slightly different stat names that should be mapped automatically).

## 4. Regular-season filtering and season range

- **Filter in the downloader**:
- Use nfl_data_py’s `season_type` (or equivalent) to keep only regular-season games (`"REG"`), both for the games dataframe and for player-game stats (by joining stats with schedules if needed).
- Filter to seasons `>= 2005` in the downloader to keep the Parquet lean and aligned with the modeling horizon, matching the logic in `data_loading._filter_regular_season_and_years`.
- **Consistency with existing filters**:
- Ensure that the downloader’s filtering mirrors the logic already in `data_loading`, so loading and additional filtering there remains idempotent and does not unexpectedly remove more data.

## 5. Integration with existing workflow

- **Usage pattern**:
- Document that the user should run the downloader once to populate `data/nfl_raw/player_stats.parquet` and `data/nfl_raw/games.parquet` before running `python -m src.main` for the first time.
- Expose the downloader as a CLI: `python -m src.download_nfl_data --start-season 2005 --end-season 2024`.
- **README updates**:
- Add a short section to `README.md` explaining how to install `nfl_data_py` (via `requirements.txt`) and how to invoke the download script.
- Clarify that advanced users can still point `config.NFL_PLAYER_GAMES_PARQUET` and `config.NFL_GAMES_PARQUET` at alternative Parquet files if they prefer another data source, as long as the columns match the canonical schema.

## 6. Validation and safety checks

- **Schema validation**:
- After downloading and renaming columns, run simple assertions in the script (or a small helper) to confirm that all required columns for player stats and games are present before writing Parquet.
- **Idempotence**:
- Optionally guard against overwriting existing Parquet files unless `--overwrite` is passed, to avoid accidental data loss.

### To-dos

- [ ] Add `nfl_data_py` to requirements.txt so the downloader can use it.
- [ ] Create `src/download_nfl_data.py` with functions to download player-game stats and games/schedules via nfl_data_py and write them to the Parquet paths in config.
- [ ] Within the download script, normalize nfl_data_py column names to match canonical columns expected by config and data_loading (ids, teams, opponent, season_type, and box-score stats).
- [ ] Update README with instructions for running the download script and how it integrates with the existing correlation pipeline.