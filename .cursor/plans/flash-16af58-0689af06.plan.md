<!-- 0689af06-e058-4b4d-8a96-c09697aa0967 f4d33494-3619-4a82-a6ac-b39f48885bf4 -->
# Plan to add simulated ROI and payout support to flashback contest simulation

## 1. Wire payout structures into `flashback_sim`

- **Identify inputs**: Use the existing contest ID parsing in [`src/flashback_sim.py`](/home/john/showdown-optimizer/src/flashback_sim.py) (from `contest-standings-*.csv`) to infer the default payout file path `data/payouts/payouts-{contest_id}.json` when `--payouts-csv` is omitted.
- **Add loader helper**: Implement a helper like `_load_payout_structure(payouts_path: Path | None, contest_id: str, num_entries: int) -> tuple[np.ndarray, float]` that:
- Resolves the effective JSON path: use the explicit `--payouts-csv` path if provided (treating it as JSON), otherwise build `data/payouts/payouts-{contest_id}.json` under `config.DATA_DIR / "payouts"`.
- Parses the JSON (shape as in `payouts-185418998.json`) and extracts:
- A `payouts` array of length `num_entries` where `payouts[pos-1] `is the cash amount for finishing position `pos` (0 for unpaid positions).
- The contest `entry_fee` (from the JSON `entryFee` field) as a float.
- Raises a clear error if the user explicitly provided a path and it is missing/invalid, and otherwise logs a warning and returns `None`/skips ROI if the inferred default file is not found.

## 2. Compute simulated and actual ROI per lineup

- **Simulated ROI**:
- Add a helper like `_compute_sim_roi(scores: np.ndarray, payouts: np.ndarray, entry_fee: float) -> np.ndarray` where `scores` is `(num_sims, num_lineups)`:
- For each simulation (row), rank lineups by score (descending) using a stable sort; map each lineup to a finishing position `pos` in `1..num_lineups`.
- Look up the cash payout per lineup from the `payouts` array and compute per-sim ROI as `(payout - entry_fee) / entry_fee`.
- Return `sim_roi` as the mean ROI across simulations for each lineup (axis 0), so negative values correspond to losing money on average as requested.
- **Actual ROI (optional but cheap and useful)**:
- Using `standings_df` (which already contains the real contest `Rank` column) and the same `payouts` and `entry_fee`, compute `actual_roi` for each lineup as `(actual_payout(rank) - entry_fee) / entry_fee`.
- Align by `EntryName` (or `EntryId` if necessary) when merging into the simulation table to avoid mismatches.

## 3. Extend the `Simulation` sheet with ROI columns

- **Integrate into `run()`** in [`src/flashback_sim.py`](/home/john/showdown-optimizer/src/flashback_sim.py):
- After computing `scores` and before building `simulation_df`, call the payout loader to get `(payouts, entry_fee)` when available.
- If payouts are available, compute `sim_roi` from `scores` and add a new `"Sim ROI"` column to `simulation_df`.
- Reorder `simulation_df` columns so that `"Sim ROI"` appears immediately before the existing `"Top 1%"` column, preserving the rest of the layout (including `Stack`, ownership metrics, etc.).
- If actual ROI is implemented, add `"Actual ROI"` near `"Actual Points"` (e.g., directly after it), but keep this as a non-breaking enhancement beyond the user-visible `Sim ROI` requirements.

## 4. Add Sim ROI to `Entrant summary`

- **Update `_build_entrant_summary`** in [`src/flashback_sim.py`](/home/john/showdown-optimizer/src/flashback_sim.py):
- If the per-lineup `simulation_df` contains a `"Sim ROI"` column, include it in the groupby aggregation with `mean` by `Entrant`.
- Rename the aggregated column to `"Avg. Sim ROI"` and insert it into the final `summary` dataframe so that the column order is:
- `Entrant`, `Entries`, `Avg. Sim ROI`, `Avg. Top 1%`, `Avg. Top 5%`, `Avg. Top 20%`, `Avg Points`.
- If `Sim ROI` is absent (because payouts were not loaded), keep the current behavior unchanged so existing workflows do not break.

## 5. Add Sim ROI to `Player summary`

- **Extend `_build_player_summary`** in [`src/flashback_sim.py`](/home/john/showdown-optimizer/src/flashback_sim.py):
- Treat `"Sim ROI"` as another per-lineup metric alongside `"Top 1%"` and `"Top 20%"`.
- When constructing the long-form table of `(Player, role)` records, carry through the lineup’s `Sim ROI` for each of the six player slots.
- In the final aggregated per-player table, add two new columns:
- `"CPT Sim ROI"`: mean `Sim ROI` across all lineups where the player appears in CPT.
- `"FLEX Sim ROI"`: mean `Sim ROI` across all lineups where the player appears in FLEX.
- Ensure these appear before the existing top-1% / top-20% rate columns, e.g. column order like: `Player`, draft and projected ownership fields, `CPT Sim ROI`, `FLEX Sim ROI`, then the `CPT/FLEX top 1% rate` and `top 20% rate` columns.
- Handle the empty-data case by returning an empty dataframe that includes the new Sim ROI columns.

## 6. CLI and configuration changes

- **Extend `run` and CLI args**:
- Update the `run()` signature to accept a new `payouts_csv: str | None = None` parameter (even though it points to JSON, per your naming preference).
- Thread this parameter through `_parse_args` and `main()` in [`src/flashback_sim.py`](/home/john/showdown-optimizer/src/flashback_sim.py) by adding:
- A `--payouts-csv` argument that accepts a path and documents that it should point to a DraftKings payout JSON file (defaulting by contest ID when omitted).
- Inside `run()`, resolve `contest_id` from the contest CSV filename once and pass it along with `payouts_csv` into the payout loader helper.
- Decide behavior when no payout file is found: raise on explicit `--payouts-csv` paths; otherwise, log a message and skip ROI computation so the script still produces the existing output sheets.

## 7. Documentation updates

- **README**:
- In [`README.md`](/home/john/showdown-optimizer/README.md), update the "Flashback" / simulation section to:
- Document the new `--payouts-csv` flag, including its defaulting behavior to `data/payouts/payouts-{contest_id}.json`.
- Describe the `Sim ROI` column in the `Simulation` sheet and how it is computed (`(expected payout − entry fee) / entry fee`).
- Mention the new `Avg. Sim ROI` column in the `Entrant summary` sheet and `CPT Sim ROI` / `FLEX Sim ROI` in the `Player summary` sheet.
- Optionally note the presence and interpretation of an `Actual ROI` column if that enhancement is included.

## 8. Light validation / sanity checks

- **Manual spot-checks**:
- Run the flashback script on an example contest with a known `payouts-*.json` file to ensure the payout loader reads the correct `totalPayouts`, `entryFee`, and tiered `payoutSummary` mapping.
- Verify that `Sim ROI` values look reasonable (e.g., average across all lineups close to the rake-adjusted expectation, negative ROI common in top-heavy structures) and that entrant and player summaries reflect the expected averages.
- Confirm that running without a payouts file still works and simply omits ROI-driven columns, matching the previous behavior.

### To-dos

- [ ] Implement payout JSON loading and rank-to-payout mapping in flashback_sim, including default path resolution and entry fee extraction.
- [ ] Add helpers to compute simulated per-lineup ROI from scores and payouts, plus optional actual ROI from real contest ranks.
- [ ] Wire Sim ROI into the Simulation sheet and propagate averaged Sim ROI into Entrant summary and CPT/FLEX Sim ROI into Player summary.
- [ ] Add the --payouts-csv flag to the flashback CLI and document ROI-related fields and usage in README.